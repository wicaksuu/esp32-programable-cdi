<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart CDI Simulator üéÆ</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        color: #fff;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      h1 {
        text-align: center;
        margin-bottom: 10px;
        font-size: 2.5em;
      }

      .subtitle {
        text-align: center;
        opacity: 0.8;
        margin-bottom: 30px;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      .card h2 {
        margin-bottom: 20px;
        font-size: 1.5em;
        border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        padding-bottom: 10px;
      }

      .control-group {
        margin-bottom: 20px;
      }

      .control-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
      }

      input[type="range"] {
        width: 100%;
        height: 8px;
        border-radius: 5px;
        background: rgba(255, 255, 255, 0.3);
        outline: none;
        -webkit-appearance: none;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #4caf50;
        cursor: pointer;
      }

      input[type="range"]::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #4caf50;
        cursor: pointer;
      }

      .value-display {
        display: inline-block;
        background: rgba(0, 0, 0, 0.3);
        padding: 5px 15px;
        border-radius: 5px;
        font-weight: bold;
        margin-left: 10px;
        min-width: 80px;
        text-align: center;
      }

      .btn {
        padding: 12px 25px;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        margin: 5px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .btn-primary {
        background: #4caf50;
        color: white;
      }

      .btn-danger {
        background: #f44336;
        color: white;
      }

      .btn-warning {
        background: #ff9800;
        color: white;
      }

      .btn-info {
        background: #2196f3;
        color: white;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-on {
        background: #4caf50;
        box-shadow: 0 0 10px #4caf50;
      }

      .status-off {
        background: #666;
      }

      .gauge {
        text-align: center;
        padding: 20px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        margin: 10px 0;
      }

      .gauge-value {
        font-size: 3em;
        font-weight: bold;
        color: #4caf50;
      }

      .gauge-label {
        font-size: 1.2em;
        opacity: 0.8;
      }

      .feature-status {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin: 15px 0;
      }

      .feature-item {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 8px;
        display: flex;
        align-items: center;
      }

      .scenario-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 10px;
      }

      .btn-scenario {
        padding: 15px;
        background: rgba(255, 255, 255, 0.2);
        border: 2px solid rgba(255, 255, 255, 0.3);
        color: white;
        font-weight: 600;
      }

      .btn-scenario:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: #4caf50;
      }

      .log {
        background: rgba(0, 0, 0, 0.5);
        padding: 15px;
        border-radius: 10px;
        max-height: 300px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
      }

      .log-entry {
        margin: 5px 0;
        padding: 5px;
        border-left: 3px solid #4caf50;
        padding-left: 10px;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .active-indicator {
        animation: pulse 1s infinite;
      }

      .navigation {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 20px 0;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 10px;
      }

      .nav-link {
        padding: 10px 20px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s;
        border: 2px solid transparent;
      }

      .nav-link:hover {
        background: rgba(255, 255, 255, 0.3);
        border-color: #4caf50;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .nav-link.active {
        background: #4caf50;
        border-color: #45a049;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üéÆ Smart CDI Simulator</h1>
      <p class="subtitle">
        Test CDI tanpa motor - Virtual inputs & Unit tests | v2.2
      </p>

      <!-- Navigation -->
      <nav class="navigation">
        <a target="_blank" href="/dashboard" class="nav-link">üèçÔ∏è Dashboard</a>
        <a target="_blank" href="/upload" class="nav-link">üìÅ File Manager</a>
        <a target="_blank" href="/wifi" class="nav-link">üì° WiFi</a>
        <a target="_blank" href="/simulator" class="nav-link active"
          >üéÆ Simulator</a
        >
      </nav>

      <!-- Control Panel -->
      <div class="grid">
        <!-- Simulator Control -->
        <div class="card">
          <h2>üéõÔ∏è Simulator Control</h2>
          <div style="text-align: center; margin: 20px 0">
            <button
              class="btn btn-primary"
              id="btnEnable"
              onclick="enableSimulator()"
            >
              Enable Simulator
            </button>
            <button
              class="btn btn-danger"
              id="btnDisable"
              onclick="disableSimulator()"
              disabled
            >
              Disable Simulator
            </button>
          </div>
          <div style="text-align: center; margin: 20px 0">
            <button
              class="btn btn-info"
              id="btnStart"
              onclick="startSimulator()"
              disabled
            >
              ‚ñ∂Ô∏è Start Engine
            </button>
            <button
              class="btn btn-warning"
              id="btnStop"
              onclick="stopSimulator()"
              disabled
            >
              ‚èπÔ∏è Stop Engine
            </button>
          </div>
          <div style="text-align: center; margin: 20px 0">
            <button class="btn btn-warning" onclick="runUnitTests()">
              üß™ Run Unit Tests
            </button>
          </div>
          <div class="feature-status">
            <div class="feature-item">
              <span class="status-indicator status-off" id="statusSim"></span>
              <span>Simulator</span>
            </div>
            <div class="feature-item">
              <span
                class="status-indicator status-off"
                id="statusEngine"
              ></span>
              <span>Engine</span>
            </div>
          </div>
        </div>

        <!-- RPM & Outputs -->
        <div class="card">
          <h2>üìä Outputs</h2>
          <div class="gauge">
            <div class="gauge-value" id="displayRPM">0</div>
            <div class="gauge-label">RPM</div>
          </div>
          <div
            style="
              display: grid;
              grid-template-columns: repeat(2, 1fr);
              gap: 10px;
              margin-top: 15px;
            "
          >
            <div class="gauge" style="padding: 10px">
              <div
                class="gauge-value"
                style="font-size: 2em"
                id="displayAdvance"
              >
                0
              </div>
              <div class="gauge-label" style="font-size: 1em">Advance (¬∞)</div>
            </div>
            <div class="gauge" style="padding: 10px">
              <div
                class="gauge-value"
                style="font-size: 2em"
                id="displayIgnCount"
              >
                0
              </div>
              <div class="gauge-label" style="font-size: 1em">Ignitions</div>
            </div>
          </div>
        </div>

        <!-- Feature Status -->
        <div class="card">
          <h2>‚öôÔ∏è Feature Status</h2>
          <div class="feature-status">
            <div class="feature-item">
              <span class="status-indicator status-off" id="statusQS"></span>
              <span>Quick Shifter</span>
            </div>
            <div class="feature-item">
              <span class="status-indicator status-off" id="statusLC"></span>
              <span>Launch Control</span>
            </div>
            <div class="feature-item">
              <span class="status-indicator status-off" id="statusAW"></span>
              <span>Anti-Wheelie</span>
            </div>
            <div class="feature-item">
              <span class="status-indicator status-off" id="statusTC"></span>
              <span>Traction Control</span>
            </div>
          </div>
          <div style="margin-top: 20px">
            <strong>Current Map:</strong> <span id="currentMapName">-</span
            ><br />
            <strong>Rev Limiter:</strong> <span id="revLimiter">-</span> RPM
          </div>
        </div>
      </div>

      <!-- Virtual Inputs -->
      <div class="card">
        <h2>üéöÔ∏è Virtual Inputs</h2>
        <div class="grid">
          <div>
            <div class="control-group">
              <label
                >RPM <span class="value-display" id="valRPM">0</span></label
              >
              <input
                type="range"
                id="inputRPM"
                min="0"
                max="50000"
                value="0"
                step="100"
              />
            </div>
            <div class="control-group">
              <label
                >Throttle
                <span class="value-display" id="valThrottle">0%</span></label
              >
              <input
                type="range"
                id="inputThrottle"
                min="0"
                max="100"
                value="0"
              />
            </div>
            <div class="control-group">
              <label
                >Speed
                <span class="value-display" id="valSpeed">0 km/h</span></label
              >
              <input type="range" id="inputSpeed" min="0" max="200" value="0" />
            </div>
          </div>
          <div>
            <div class="control-group">
              <label
                >QS Pressure
                <span class="value-display" id="valQS">2048</span></label
              >
              <input
                type="range"
                id="inputQS"
                min="0"
                max="4095"
                value="2048"
              />
            </div>
            <div class="control-group">
              <label
                >Pitch Angle
                <span class="value-display" id="valPitch">0¬∞</span></label
              >
              <input
                type="range"
                id="inputPitch"
                min="-30"
                max="60"
                value="0"
              />
            </div>
            <div class="control-group">
              <label
                >Wheel Slip
                <span class="value-display" id="valSlip">0%</span></label
              >
              <input type="range" id="inputSlip" min="0" max="100" value="0" />
            </div>
          </div>
        </div>
        <div style="text-align: center; margin-top: 20px">
          <button class="btn btn-primary" onclick="applyInputs()">
            Apply Inputs
          </button>
          <button class="btn btn-warning" onclick="resetInputs()">
            Reset All
          </button>
        </div>
      </div>

      <!-- Test Scenarios -->
      <div class="card">
        <h2>üß™ Test Scenarios</h2>
        <p style="opacity: 0.8; margin-bottom: 15px">
          Click a scenario to automatically configure inputs and test specific
          features:
        </p>
        <div class="scenario-grid">
          <button class="btn btn-scenario" onclick="runScenario('idle')">
            üîµ Idle Test
          </button>
          <button class="btn btn-scenario" onclick="runScenario('accel')">
            ‚ö° Accel Sweep
          </button>
          <button class="btn btn-scenario" onclick="runScenario('revlimit')">
            üî¥ Rev Limiter
          </button>
          <button class="btn btn-scenario" onclick="runScenario('quickshift')">
            ‚öôÔ∏è QS Test
          </button>
          <button class="btn btn-scenario" onclick="runScenario('launch')">
            üöÄ LC Test
          </button>
          <button class="btn btn-scenario" onclick="runScenario('wheelie')">
            üèçÔ∏è Anti-Wheelie
          </button>
          <button class="btn btn-scenario" onclick="runScenario('traction')">
            üõû TC Test
          </button>
          <button
            class="btn btn-scenario"
            onclick="runScenario('2stroke_powerband')"
          >
            üî• Powerband Surge
          </button>
        </div>
      </div>

      <!-- Log -->
      <div class="card">
        <h2>üìù Activity Log</h2>
        <div class="log" id="activityLog">
          <div class="log-entry">Waiting for simulator to start...</div>
        </div>
        <button
          class="btn btn-warning"
          onclick="clearLog()"
          style="margin-top: 10px"
        >
          Clear Log
        </button>
      </div>
    </div>

    <script>
      let updateInterval = null;

      // Update input displays
      document.getElementById("inputRPM").oninput = (e) => {
        document.getElementById("valRPM").textContent = e.target.value;
      };
      document.getElementById("inputThrottle").oninput = (e) => {
        document.getElementById("valThrottle").textContent =
          e.target.value + "%";
      };
      document.getElementById("inputSpeed").oninput = (e) => {
        document.getElementById("valSpeed").textContent =
          e.target.value + " km/h";
      };
      document.getElementById("inputQS").oninput = (e) => {
        document.getElementById("valQS").textContent = e.target.value;
      };
      document.getElementById("inputPitch").oninput = (e) => {
        document.getElementById("valPitch").textContent = e.target.value + "¬∞";
      };
      document.getElementById("inputSlip").oninput = (e) => {
        document.getElementById("valSlip").textContent = e.target.value + "%";
      };

      // Enable Simulator
      async function enableSimulator() {
        const response = await fetch("/api/simulator?action=enable");
        const data = await response.json();
        if (data.success) {
          document.getElementById("btnEnable").disabled = true;
          document.getElementById("btnDisable").disabled = false;
          document.getElementById("btnStart").disabled = false;
          document.getElementById("statusSim").classList.add("status-on");
          document.getElementById("statusSim").classList.remove("status-off");
          addLog("‚úÖ Simulator enabled");
          startAutoUpdate();
        }
      }

      // Disable Simulator
      async function disableSimulator() {
        const response = await fetch("/api/simulator?action=disable");
        const data = await response.json();
        if (data.success) {
          document.getElementById("btnEnable").disabled = false;
          document.getElementById("btnDisable").disabled = true;
          document.getElementById("btnStart").disabled = true;
          document.getElementById("btnStop").disabled = true;
          document.getElementById("statusSim").classList.remove("status-on");
          document.getElementById("statusSim").classList.add("status-off");
          document.getElementById("statusEngine").classList.remove("status-on");
          document.getElementById("statusEngine").classList.add("status-off");
          addLog("‚èπÔ∏è Simulator disabled");
          stopAutoUpdate();
        }
      }

      // Start Engine
      async function startSimulator() {
        const response = await fetch("/api/simulator?action=start");
        const data = await response.json();
        if (data.success) {
          document.getElementById("btnStart").disabled = true;
          document.getElementById("btnStop").disabled = false;
          document.getElementById("statusEngine").classList.add("status-on");
          document
            .getElementById("statusEngine")
            .classList.remove("status-off");
          addLog("‚ñ∂Ô∏è Engine started");
        }
      }

      // Stop Engine
      async function stopSimulator() {
        const response = await fetch("/api/simulator?action=stop");
        const data = await response.json();
        if (data.success) {
          document.getElementById("btnStart").disabled = false;
          document.getElementById("btnStop").disabled = true;
          document.getElementById("statusEngine").classList.remove("status-on");
          document.getElementById("statusEngine").classList.add("status-off");
          addLog("‚èπÔ∏è Engine stopped");
        }
      }

      // Apply Inputs
      async function applyInputs() {
        const inputs = {
          action: "setInputs",
          rpm: parseInt(document.getElementById("inputRPM").value),
          throttle: parseInt(document.getElementById("inputThrottle").value),
          speed: parseFloat(document.getElementById("inputSpeed").value),
          qsPressure: parseInt(document.getElementById("inputQS").value),
          pitch: parseFloat(document.getElementById("inputPitch").value),
          slip: parseFloat(document.getElementById("inputSlip").value) / 100,
        };

        const response = await fetch("/api/simulator", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(inputs),
        });

        const data = await response.json();
        if (data.success) {
          addLog(
            `üéöÔ∏è Inputs applied: RPM=${inputs.rpm}, Throttle=${inputs.throttle}%`
          );
        }
      }

      // Reset Inputs
      function resetInputs() {
        document.getElementById("inputRPM").value = 0;
        document.getElementById("inputThrottle").value = 0;
        document.getElementById("inputSpeed").value = 0;
        document.getElementById("inputQS").value = 2048;
        document.getElementById("inputPitch").value = 0;
        document.getElementById("inputSlip").value = 0;
        // Trigger oninput to update displays
        document.getElementById("inputRPM").oninput({ target: { value: 0 } });
        document
          .getElementById("inputThrottle")
          .oninput({ target: { value: 0 } });
        document.getElementById("inputSpeed").oninput({ target: { value: 0 } });
        document.getElementById("inputQS").oninput({ target: { value: 2048 } });
        document.getElementById("inputPitch").oninput({ target: { value: 0 } });
        document.getElementById("inputSlip").oninput({ target: { value: 0 } });
        applyInputs();
        addLog("üîÑ Inputs reset to defaults");
      }

      // Run Scenario
      async function runScenario(scenario) {
        const response = await fetch("/api/simulator", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ action: "runScenario", scenario: scenario }),
        });

        const data = await response.json();
        if (data.success) {
          addLog(`üß™ Running scenario: ${scenario}`);
        }
      }

      // Run Unit Tests
      function runUnitTests() {
        addLog("üß™ Running unit tests... (check Serial Monitor for results)");
        // Tests run on ESP32 side, just log here
      }

      // Update Status
      async function updateStatus() {
        try {
          const response = await fetch("/api/simulator?action=status");
          const data = await response.json();

          // Update outputs
          document.getElementById("displayRPM").textContent =
            data.inputs.rpm || 0;
          document.getElementById("displayAdvance").textContent =
            data.outputs.advanceDegrees || 0;
          document.getElementById("displayIgnCount").textContent =
            data.outputs.ignitionCount || 0;

          // Update feature status
          updateIndicator("statusQS", data.features.qsActive);
          updateIndicator("statusLC", data.features.lcActive);
          updateIndicator("statusAW", data.features.antiWheelieActive);
          updateIndicator("statusTC", data.features.tractionControlActive);

          // Update map info
          document.getElementById("currentMapName").textContent =
            data.currentMap.name || "-";
          document.getElementById("revLimiter").textContent =
            data.currentMap.revLimiterRPM || "-";
        } catch (error) {
          console.error("Update failed:", error);
        }
      }

      function updateIndicator(id, active) {
        const elem = document.getElementById(id);
        if (active) {
          elem.classList.add("status-on");
          elem.classList.remove("status-off");
        } else {
          elem.classList.remove("status-on");
          elem.classList.add("status-off");
        }
      }

      // Auto-update
      function startAutoUpdate() {
        if (updateInterval) clearInterval(updateInterval);
        updateInterval = setInterval(updateStatus, 200); // 5 Hz update
      }

      function stopAutoUpdate() {
        if (updateInterval) {
          clearInterval(updateInterval);
          updateInterval = null;
        }
      }

      // Log functions
      function addLog(message) {
        const log = document.getElementById("activityLog");
        const time = new Date().toLocaleTimeString();
        const entry = document.createElement("div");
        entry.className = "log-entry";
        entry.textContent = `[${time}] ${message}`;
        log.appendChild(entry);
        log.scrollTop = log.scrollHeight;
      }

      function clearLog() {
        document.getElementById("activityLog").innerHTML =
          '<div class="log-entry">Log cleared.</div>';
      }

      // Initial update
      updateStatus();
    </script>
  </body>
</html>
